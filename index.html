<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Chatbot Sanitario</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="chat">
  <h2>ğŸ©º PREVENTION TEST ğŸ©¸</h2>
  <div id="messages"></div>
  <div id="input-container">
    <input id="input" placeholder="Scrivi qui..." />
    <button onclick="next()">Invia</button>
  </div>
</div>

<script>
  const introduzione = "Benvenuto! Questo Ã¨ un test di prevenzione sanitaria completo, progettato per aiutarti a valutare il tuo stato di salute e identificare possibili fattori di rischio. Compilare il test richiederÃ  circa 20 minuti, ma potrebbe davvero fare la differenza nella tua vita. Le tue risposte saranno utilizzate per fornirti consigli personalizzati secondo le linee guida sanitarie ufficiali. Iniziamo quando sei pronto!";

  const domandeBase = [
    { key: "eta", testo: "Quanti anni hai?" },
    { key: "sesso", testo: "Qual Ã¨ il tuo sesso biologico? (maschio/femmina)" },
    { key: "origine_etnica", testo: "Qual Ã¨ la tua origine etnica?" },
    { key: "altezza", testo: "Quanto sei alto/a in cm?" },
    { key: "peso", testo: "Quanto pesi in kg?" },
    { key: "vita", testo: "La misura del tuo giro vita Ã¨ maggiore di 88 cm (se sei donna) o maggiore di 102 cm (se sei uomo)?" },
    { key: "glicemia", testo: "La tua glicemia Ã¨ inferiore a 100 mg/dL?" },
    { key: "colesterolo_totale", testo: "Qual Ã¨ il valore del tuo colesterolo totale (mg/dL)?" },
    { key: "colesterolo_ldl", testo: "Il tuo colesterolo LDL supera il valore di 70 mg/dL?" },
    { key: "colesterolo_hdl", testo: "Il tuo colesterolo HDL Ã¨ inferiore a 50 mg/dL (se sei donna) o inferiore a 40 mg/dL (se sei uomo)?" },
    { key: "pressione", testo: "La tua pressione arteriosa media Ã¨ inferiore a 130/85 mmHg?" },
    { key: "malattie_croniche", testo: "Hai malattie croniche diagnosticate?" },
    { key: "farmaci", testo: "Assumi farmaci?" },
    { key: "farmaci_dettaglio", testo: "Se assumi farmaci, elencali nella casella di testo sottostante." },
    { key: "interventi", testo: "Hai subito interventi chirurgici rilevanti?" },
    { key: "interventi_dettaglio", testo: "Se hai subito interventi chirurgici rilevanti, elencali nella casella di testo sottostante." },
    { key: "familiarita_tumori", testo: "Ci sono in famiglia casi di tumore?" },
    { key: "sede_tumore", testo: "In quale sede ha avuto un tumore il tuo famigliare?" },
    { key: "fumatore", testo: "Fumi?" },
    { key: "n_sigarette", testo: "Quante sigarette fumi al giorno?" },
    { key: "alcol", testo: "Consumo di alcolici?" },
    { key: "unita_alcoliche", testo: "Quante unitÃ  alcoliche bevi al giorno? (1 unitÃ  = 1 bicchiere di vino / birra / shot)" },
    { key: "attivita_fisica", testo: "Svolgi attivitÃ  fisica settimanale?" },
    { key: "tipo_attivita", testo: "Che tipo di attivitÃ  fisica svolgi?" },
    { key: "durata_attivita", testo: "Quanto dura ogni allenamento? (in minuti)" },
    { key: "alimentazione", testo: "Com'Ã¨ la tua alimentazione?" },
    { key: "stanchezza", testo: "In genere ti senti stanco/a?" },
    { key: "depressione", testo: "Hai episodi di depressione?" },
    { key: "insonnia", testo: "Hai difficoltÃ  a dormire?" },
    { key: "tipo_insonnia", testo: "Se hai difficoltÃ  a dormire, descrivi la difficoltÃ  (es. fatica ad addormentarti, risvegli notturni...)" },
    { key: "stress", testo: "Livello percepito di stress (da 1 = niente stress a 10 = stress molto elevato)" },
    { key: "screening_effettuati", testo: "Hai giÃ  effettuato screening preventivi?" },
    { key: "data_ultimo_screening", testo: "Data dell'ultimo screening (formato MM-GG-AAAA):" },
    { key: "preferenze", testo: "Vorresti ricevere consigli su aspetti specifici della tua salute?" }
  ];

  const domandeOver65 = [
    { key: "over_stanchezza", testo: "Ti senti stanco/a frequentemente?" },
    { key: "over_scale", testo: "Riesci a salire una rampa di scale?" },
    { key: "over_camminata", testo: "Riesci a camminare un isolato (circa 100 metri)?" },
    { key: "over_malattie", testo: "Hai piÃ¹ di 5 malattie croniche?" },
    { key: "over_peso", testo: "Hai perso piÃ¹ di 5 kg nellâ€™ultimo anno senza volerlo?" },
    { key: "over_sollevamento", testo: "Hai difficoltÃ  a sollevare oggetti pesanti (>4.5 kg)?" },
    { key: "over_sedia", testo: "Hai problemi ad alzarti da una sedia?" },
    { key: "over_cadute", testo: "Hai cadute frequenti?" },
    { key: "over_debolezza", testo: "Ti senti debole?" }
  ];

  const domandeFemminili = [
    { key: "eta_menarca", testo: "A che etÃ  hai avuto il primo ciclo mestruale?" },
    { key: "contraccettivi", testo: "Hai mai usato contraccettivi ormonali?" },
    { key: "gravidezza", testo: "Hai avuto una o piÃ¹ gravidanze?" },
    { key: "eta_menopausa", testo: "A che etÃ  sei andata in menopausa? (facoltativo)" },
    { key: "familiarita_seno", testo: "Tua madre o tua nonna hanno avuto un tumore al seno?" },
    { key: "screening_seno", testo: "Hai mai svolto una mammografia o un'ecografia mammaria? (se hai piÃ¹ di 25 anni)" },
    { key: "papsmear", testo: "Svolgi regolarmente il Pap test? (se hai piÃ¹ di 25 anni)" }
  ];

  let domande = [...domandeBase];
  let risposte = {};
  let step = -1;

  function mostraMessaggio(testo, classe = "bot") {
    const div = document.createElement("div");
    div.className = `bubble ${classe}`;
    div.innerText = testo;
    document.getElementById("messages").appendChild(div);
    div.scrollIntoView();
  }

  function next() {
    const input = document.getElementById("input");
    const val = input.value.trim();
    if (!val) return;

    mostraMessaggio(val, "user");
    if (step >= 0) risposte[domande[step].key] = val;
    input.value = "";

    if (step >= 0 && domande[step].key === "eta") {
      const etaNum = parseInt(val);
      if (!isNaN(etaNum) && etaNum > 65) {
        domande = [...domande.slice(0, step + 1), ...domandeOver65, ...domande.slice(step + 1)];
      }
    }

    if (step >= 0 && domande[step].key === "sesso") {
      const sesso = val.toLowerCase();
      if (sesso === "femmina" || sesso === "donna") {
        domande = [...domande.slice(0, step + 1), ...domandeFemminili, ...domande.slice(step + 1)];
      }
    }

    step++;
    if (step < domande.length) {
      setTimeout(() => mostraMessaggio(domande[step].testo), 500);
    } else {
      mostraMessaggio("ğŸ§  Grazie! Sto analizzando i tuoi dati...");
      inviaOpenAI();
    }
  }

  function inviaOpenAI() {
    fetch("https://TUA-API.herokuapp.com/api/analizza", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(risposte)
    })
    .then(res => res.json())
    .then(data => {
      mostraMessaggio("ğŸ§ Risposta dell'AI:");
      mostraMessaggio(data.risposta);
    });
  }

  mostraMessaggio(introduzione);
</script>

</body>
</html>
