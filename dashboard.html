<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - HealthAI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --primary-light: #5a7fb5;
            --primary-dark: #3a5f95;
            --accent-color: #54c0a0;
            --text-color: #333333;
            --text-light: #777777;
            --background-color: #f9f9fb;
            --card-color: #ffffff;
            --border-color: #e0e0e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --bot-message-bg: #eef4ff;
            --user-message-bg: #54c0a0;
            --user-message-text: white;
            --font-family: 'Segoe UI', 'Roboto', sans-serif;
            --radius: 20px;
            --animation-speed: 0.3s;
            --primary-blue: #4285F4;
            --primary-light-blue: #E8F0FE;
            --light-gray: #F8F9FA;
            --text-dark: #202124;
            --text-medium: #5F6368;

            /* Nuove variabili per supportare meglio il tema */
            --card-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --highlight-bg: #e8f0fe;
            --success-bg: #E6F4EA;
            --success-color: #34A853;
            --warning-bg: #FEF7E0;
            --warning-color: #FBBC05;
            --danger-bg: #FCE8E6;
            --danger-color: #EA4335;
            --header-bg: #ffffff;
            --footer-bg: #202124;
            --footer-text: #ffffff;
            --score-low-bg: #FBBC05;
            --score-medium-bg: #34A853;
            --score-high-bg: #EA4335;
            --badge-text: #ffffff;
            --progress-bg: #e0e0e6;
            --border-highlight: #4285F4;
            --border-success: #34A853;
            --border-warning: #FBBC05;
            --border-danger: #EA4335;
            --button-primary-bg: #4285F4;
            --button-primary-text: #ffffff;
            --button-hover-bg: #357ae8;
            --icon-color: #4285F4;
            --link-color: #4285F4;
            --link-hover: #357ae8;
            --tab-active-bg: #4285F4;
            --tab-active-text: #ffffff;
            --tab-inactive-bg: transparent;
            --tab-inactive-text: #5F6368;
            --gradient-primary: linear-gradient(135deg, #4285F4, #34A853);
            --gradient-secondary: linear-gradient(135deg, #4285F4, #5B8DEF);
            --chart-text-color: #333333;
            --footer-bg: var(--card-color);
            --animation-speed: 0.3s;
        }

        [data-theme="dark"] {
            --primary-color: #5a7fb5;
            --primary-light: #6a8fc5;
            --primary-dark: #4a6fa5;
            --accent-color: #64d0b0;
            --text-color: #e0e0e0;
            --text-light: #a0a0a0;
            --background-color: #1a1a20;
            --card-color: #27272f;
            --border-color: #3a3a45;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --bot-message-bg: #2a3548;
            --user-message-bg: #446655;
            --user-message-text: #e0e0e0;
            --text-dark: #e0e0e0;
            --text-medium: #a0a0a0;

            /* Nuove variabili per tema scuro */
            --card-bg: #27272f;
            --secondary-bg: #1f1f27;
            --highlight-bg: #2a3548;
            --success-bg: #1e3a2e;
            --success-color: #4eca6f;
            --warning-bg: #3d3520;
            --warning-color: #ffce44;
            --danger-bg: #3d2a27;
            --danger-color: #ff7169;
            --header-bg: #27272f;
            --footer-bg: #1a1a20;
            --footer-text: #a0a0a0;
            --score-low-bg: #ffce44;
            --score-medium-bg: #4eca6f;
            --score-high-bg: #ff7169;
            --badge-text: #1a1a20;
            --progress-bg: #3a3a45;
            --border-highlight: #5a7fb5;
            --border-success: #4eca6f;
            --border-warning: #ffce44;
            --border-danger: #ff7169;
            --button-primary-bg: #5a7fb5;
            --button-primary-text: #e0e0e0;
            --button-hover-bg: #6a8fc5;
            --icon-color: #5a7fb5;
            --link-color: #6a8fc5;
            --link-hover: #7a9fd5;
            --tab-active-bg: #5a7fb5;
            --tab-active-text: #e0e0e0;
            --tab-inactive-bg: transparent;
            --tab-inactive-text: #a0a0a0;
            --gradient-primary: linear-gradient(135deg, #5a7fb5, #4eca6f);
            --gradient-secondary: linear-gradient(135deg, #5a7fb5, #6a8fc5);
            --chart-text-color: #ffffff;
            --footer-bg: var(--card-color);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color var(--animation-speed);
        }

        /* Aggiungi questa regola al tuo CSS */
        *, *::before, *::after {
            transition: background-color var(--animation-speed), box-shadow var(--animation-speed);
        }

        .card, .badge, .score-indicator, .tab-button, .recommendation-card,
        ., .bg-gray-50, .bg-blue-50, .bg-gray-200, .bg-blue-100,
        .border-l-4, svg circle, svg text, .progress-ring__circle {
            transition: all var(--animation-speed);
        }

        .card {
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px var(--border-color);
            transition: transform var(--animation-speed), box-shadow var(--animation-speed), border-color var(--animation-speed);
        }


        .primary-gradient {
            background: var(--gradient-primary);
        }

        .secondary-gradient {
            background: var(--gradient-secondary);
        }

        .score-indicator {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .score-low {
            background-color: var(--score-low-bg);
            color: var(--badge-text);
        }

        .score-medium {
            background-color: var(--score-medium-bg);
            color: var(--badge-text);
        }

        .score-high {
            background-color: var(--score-high-bg);
            color: var(--badge-text);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--tab-inactive-text);
            background-color: var(--tab-inactive-bg);
            transition: background-color var(--animation-speed);
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            color: var(--tab-active-text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Personalizzazioni per grafici e indicatori */
        .progress-ring {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-ring__circle {
            stroke-dasharray: 314.16;
            transition: stroke-dashoffset var(--animation-speed);
        }

        .badge {
            border-radius: 16px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: var(--success-bg);
            color: var(--success-color);
        }

        .badge-warning {
            background-color: var(--warning-bg);
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: var(--danger-bg);
            color: var(--danger-color);
        }

        .recommendation-card {
            border-left: 3px solid var(--border-highlight);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            outline: none;
            transition: transform var(--animation-speed);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Stili specifici per elementi vari */
        . {
            background-color: var(--card-bg) !important;
        }

        .bg-gray-50, .bg-blue-50 {
            background-color: var(--secondary-bg) !important;
        }

        .text-gray-600, .text-gray-500 {
            color: var(--text-light) !important;
        }

        .text-blue-500, .text-blue-600 {
            color: var(--link-color) !important;
        }

        .text-yellow-600 {
            color: var(--warning-color) !important;
        }

        .text-red-600, .text-red-500 {
            color: var(--danger-color) !important;
        }

        .text-green-600, .text-green-500 {
            color: var(--success-color) !important;
        }

        .bg-gray-200 {
            background-color: var(--progress-bg) !important;
        }

        .bg-red-500 {
            background-color: var(--danger-color) !important;
        }

        .bg-green-500 {
            background-color: var(--success-color) !important;
        }

        .bg-yellow-500 {
            background-color: var(--warning-color) !important;
        }

        .bg-blue-500 {
            background-color: var(--button-primary-bg) !important;
        }

        .bg-blue-100 {
            background-color: var(--highlight-bg) !important;
        }

        .hover\:bg-blue-600:hover {
            background-color: var(--button-hover-bg) !important;
        }

        .hover\:bg-blue-50:hover {
            background-color: var(--secondary-bg) !important;
        }

        .hover\:text-blue-700:hover, .hover\:text-white:hover {
            color: var(--link-hover) !important;
        }

        .border-l-4.border-green-500 {
            border-left-color: var(--border-success) !important;
        }

        .border-l-4.border-yellow-500 {
            border-left-color: var(--border-warning) !important;
        }

        .border-l-4.border-red-500 {
            border-left-color: var(--border-danger) !important;
        }

        .border-l-4.border-blue-500 {
            border-left-color: var(--border-highlight) !important;
        }

        /* Footer specifico */
        .bg-gray-800 {
            background-color: var(--footer-bg) !important;
        }

        .text-gray-300 {
            color: var(--footer-text) !important;
        }

        .dashboard-main {
          transition: background-color var(--animation-speed);
        }
        </style>
</head>
<body>
    <!-- Header -->
    <header class="shadow-sm mb-4 sticky top-0 z-10 chat-header" style="background-color: var(--card-color); color: var(--text-color); border-bottom: 1px solid var(--border-color); transition: border-color var(--animation-speed);">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <svg class="h-6 w-6 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
                <h1 class="text-xl font-bold">Dashboard HealthAI</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full flex items-center text-sm">
                    <i class="fas fa-file-pdf mr-2"></i>
                    Esporta report
                </button>
                <button class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4">
              <button id="theme-toggle" class="text-blue-500 text-xl hover:text-blue-700">üåô</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main container mx-auto px-4 pb-8">
        <!-- Panoramica principale -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card  p-4 col-span-2">
                <h2 class="text-lg font-bold mb-3">Riepilogo Salute</h2>
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 bg-blue-50 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-600">BMI</h3>
                            <span class="badge badge-success">Normale</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="score-indicator score-medium">23.5</div>
                            <div>
                                <div class="text-sm text-gray-500">Categoria</div>
                                <div class="font-medium">Normopeso</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 bg-blue-50 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-600">SCORE2</h3>
                            <span class="badge badge-warning">Moderato</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="score-indicator score-low">2.5%</div>
                            <div>
                                <div class="text-sm text-gray-500">Rischio CV</div>
                                <div class="font-medium">Moderato</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 bg-blue-50 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-600">PREDIMED</h3>
                            <span class="badge badge-warning">Migliorabile</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="score-indicator score-low">8</div>
                            <div>
                                <div class="text-sm text-gray-500">Dieta</div>
                                <div class="font-medium">Media aderenza</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card  p-4">
                <h2 class="text-lg font-bold mb-3">Profilo Metabolico</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Sindrome Metabolica</span>
                        <span class="badge badge-danger">Presente</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-red-500 h-2.5 rounded-full" style="width: 75%"></div>
                    </div>
                    <div class="text-xs text-gray-500">
                        3 criteri soddisfatti su 5
                    </div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <div class="badge badge-danger">Girovita elevato</div>
                        <div class="badge badge-danger">Glicemia alta</div>
                        <div class="badge badge-danger">HDL basso</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs per il contenuto dettagliato -->
        <div class="card  p-4 mb-6">
            <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                <button class="tab-button active" data-tab="tab-rischi">Rischi</button>
                <button class="tab-button" data-tab="tab-screening">Screening</button>
                <button class="tab-button" data-tab="tab-stile-vita">Stile di vita</button>
                <button class="tab-button" data-tab="tab-nutritional">Nutrizione</button>
                <button class="tab-button" data-tab="tab-attivita">Attivit√† fisica</button>
            </div>

            <!-- Contenuto tab rischi -->
            <div id="tab-rischi" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Rischio Cardiovascolare</h3>
                        <div class="flex items-center justify-center mb-4">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#e6e6e6" stroke-width="10"></circle>
                                <circle class="progress-ring__circle" cx="60" cy="60" r="50" fill="none" stroke="#4285F4" stroke-width="10" stroke-dashoffset="220" stroke-linecap="round"></circle>
                                <text x="60" y="65" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--chart-text-color)">2.5%</text>
                            </svg>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Et√†</span>
                                <span class="font-medium">55 anni</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Pressione</span>
                                <span class="font-medium">145/85 mmHg</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Colesterolo</span>
                                <span class="font-medium">HDL 45 mg/dL</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Fumo</span>
                                <span class="font-medium">No</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Rischio Diabete (ADA)</h3>
                        <div class="flex items-center justify-center mb-4">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#e6e6e6" stroke-width="10"></circle>
                                <circle class="progress-ring__circle" cx="60" cy="60" r="50" fill="none" stroke="#FBBC05" stroke-width="10" stroke-dashoffset="157" stroke-linecap="round"></circle>
                                <text x="60" y="65" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--chart-text-color)">4/8</text>
                            </svg>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Glicemia</span>
                                <span class="font-medium text-yellow-600">105 mg/dL</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Familiarit√† diabete</span>
                                <span class="font-medium text-red-600">S√¨</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Ipertensione</span>
                                <span class="font-medium text-red-600">S√¨</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Attivit√† fisica</span>
                                <span class="font-medium text-red-600">Insufficiente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto tab screening -->
            <div id="tab-screening" class="tab-content">
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">Screening Raccomandati</h3>
                        <div class="space-y-3">
                            <div class="flex items-center p-2  rounded border-l-4 border-green-500">
                                <div class="flex-1">
                                    <h4 class="font-medium">Screening Colon-retto</h4>
                                    <p class="text-sm text-gray-600">Raccomandato ogni 2 anni dopo i 50 anni</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="badge badge-success">Completo</span>
                                    <span class="text-xs text-gray-500">2024</span>
                                </div>
                            </div>
                            <div class="flex items-center p-2  rounded border-l-4 border-yellow-500">
                                <div class="flex-1">
                                    <h4 class="font-medium">Controllo Pressione</h4>
                                    <p class="text-sm text-gray-600">Raccomandato annualmente</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="badge badge-warning">In scadenza</span>
                                    <span class="text-xs text-gray-500">1 mese</span>
                                </div>
                            </div>
                            <div class="flex items-center p-2  rounded border-l-4 border-red-500">
                                <div class="flex-1">
                                    <h4 class="font-medium">Esami Sangue</h4>
                                    <p class="text-sm text-gray-600">Raccomandato annualmente</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="badge badge-danger">Scaduto</span>
                                    <span class="text-xs text-gray-500">3 mesi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">Visite Specialistiche Suggerite</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-2  rounded">
                                <div>
                                    <h4 class="font-medium">Visita Cardiologica</h4>
                                    <p class="text-sm text-gray-600">Per rivalutazione parametri cardiovascolari</p>
                                </div>
                                <span class="text-blue-500 cursor-pointer hover:underline">Prenota</span>
                            </div>
                            <div class="flex justify-between items-center p-2  rounded">
                                <div>
                                    <h4 class="font-medium">Visita Diabetologica</h4>
                                    <p class="text-sm text-gray-600">Per valutazione rischio diabete</p>
                                </div>
                                <span class="text-blue-500 cursor-pointer hover:underline">Prenota</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto tab stile di vita -->
            <div id="tab-stile-vita" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Valutazione PREDIMED</h3>
                        <div class="flex justify-center mb-4">
                            <canvas id="predimed-chart" width="300" height="300"></canvas>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Punteggio attuale: <span class="font-medium">8/14</span></p>
                            <p class="text-sm text-gray-600">Aderenza alla dieta mediterranea: <span class="font-medium">Media</span></p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Benessere Psicologico</h3>
                        <div class="space-y-4">
                            <div class="p-3  rounded-lg">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium">Stress</span>
                                    <span class="text-sm font-medium text-yellow-600">Medio</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="p-3  rounded-lg">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium">Sonno</span>
                                    <span class="text-sm font-medium text-red-600">Insufficiente</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: 30%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Insonnia moderata</p>
                            </div>
                            <div class="p-3  rounded-lg">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium">Umore</span>
                                    <span class="text-sm font-medium text-green-600">Buono</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto tab nutrizione -->
            <div id="tab-nutritional" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Fabbisogno Calorico</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">BMR</span>
                                <span class="font-medium">1650 kcal</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">TDEE</span>
                                <span class="font-medium">2200 kcal</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Obiettivo</span>
                                <span class="font-medium">Dimagrimento moderato</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Calorie suggerite</span>
                                <span class="font-medium text-blue-600">1900 kcal</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Attivit√† fisica</span>
                                <span class="font-medium">Moderatamente attivo</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Ripartizione Macronutrienti</h3>
                        <div class="flex justify-center mb-3">
                            <canvas id="macro-chart" width="200" height="200"></canvas>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="p-2  rounded-lg">
                                <div class="text-sm font-medium">Proteine</div>
                                <div class="text-lg font-bold text-green-600">25%</div>
                                <div class="text-xs text-gray-500">119g</div>
                            </div>
                            <div class="p-2  rounded-lg">
                                <div class="text-sm font-medium">Carboidrati</div>
                                <div class="text-lg font-bold text-blue-600">45%</div>
                                <div class="text-xs text-gray-500">214g</div>
                            </div>
                            <div class="p-2  rounded-lg">
                                <div class="text-sm font-medium">Grassi</div>
                                <div class="text-lg font-bold text-yellow-600">30%</div>
                                <div class="text-xs text-gray-500">63g</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto tab attivit√† fisica -->
            <div id="tab-attivita" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Attivit√† Attuale</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Frequenza</span>
                                <span class="font-medium">2 volte/settimana</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Tipo</span>
                                <span class="font-medium">Camminata veloce</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Durata</span>
                                <span class="font-medium">30 minuti</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Intensit√†</span>
                                <span class="font-medium text-yellow-600">Moderata</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Minuti/settimana</span>
                                <span class="font-medium text-red-600">60 (< 150 min)</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Suggerimenti Personalizzati</h3>
                        <div class="space-y-3">
                            <div class="p-3  rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-medium">Obiettivo Principale</h4>
                                <p class="text-sm text-gray-600">Aumentare l'attivit√† aerobica a 150 min/settimana</p>
                            </div>
                            <div class="p-3  rounded-lg border-l-4 border-green-500">
                                <h4 class="font-medium">Tipo di Allenamento</h4>
                                <p class="text-sm text-gray-600">Combinare cardio (60%) e forza (40%)</p>
                            </div>
                            <div class="p-3  rounded-lg border-l-4 border-yellow-500">
                                <h4 class="font-medium">Progressione</h4>
                                <p class="text-sm text-gray-600">Aumentare di 10 min/settimana fino a 150 min</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raccomandazioni personalizzate -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="card  p-4">
                <h2 class="text-lg font-bold mb-3">Suggerimenti Prioritari</h2>
                <div class="space-y-3">
                    <div class="recommendation-card p-3 bg-gray-50">
                        <h3 class="font-medium">Migliorare il controllo glicemico</h3>
                        <p class="text-sm text-gray-600">Ridurre l'apporto di carboidrati semplici e aumentare l'attivit√† fisica</p>
                    </div>
                    <div class="recommendation-card p-3 bg-gray-50">
                        <h3 class="font-medium">Aumentare l'attivit√† fisica</h3>
                        <p class="text-sm text-gray-600">Raggiungere almeno 150 minuti di attivit√† moderata a settimana</p>
                    </div>
                    <div class="recommendation-card p-3 bg-gray-50">
                        <h3 class="font-medium">Migliorare la qualit√† del sonno</h3>
                        <p class="text-sm text-gray-600">Creare una routine serale e limitare l'uso di dispositivi elettronici</p>
                    </div>
                </div>
            </div>
            <div class="card  p-4">
                <h2 class="text-lg font-bold mb-3">Prossimi Passi</h2>
                <div class="space-y-3">
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="bg-blue-100 text-blue-800 h-8 w-8 rounded-full flex items-center justify-center mr-3">1</div>
                        <div>
                            <h4 class="font-medium">Visita diabetologica</h4>
                            <p class="text-xs text-gray-500">Entro 30 giorni</p>
                        </div>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="bg-blue-100 text-blue-800 h-8 w-8 rounded-full flex items-center justify-center mr-3">2</div>
                        <div>
                            <h4 class="font-medium">Esami del sangue</h4>
                            <p class="text-xs text-gray-500">Entro 2 settimane</p>
                        </div>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="bg-blue-100 text-blue-800 h-8 w-8 rounded-full flex items-center justify-center mr-3">3</div>
                        <div>
                            <h4 class="font-medium">Iniziare il piano alimentare</h4>
                            <p class="text-xs text-gray-500">Immediatamente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Banner finale
        <div class="card secondary-gradient text-white p-6 text-center">
            <h2 class="text-xl font-bold mb-2">Monitora la tua salute con HealthAI</h2>
            <p class="mb-4">Puoi migliorare il tuo benessere seguendo i nostri consigli personalizzati</p>
            <button class=" text-blue-500 hover:bg-blue-50 font-medium py-2 px-6 rounded-full">
                Prenota una consulenza
            </button>
        </div>-->
    </main>

    <!-- Footer -->
    <footer class="py-4 mt-8" style="border-top: 1px solid var(--border-color); background-color: var(--card-color); color: var(--text-color); transition: border-color var(--animation-speed);">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 HealthAI - Sistema di monitoraggio della salute</p>
            <div class="mt-2">
                <a href="#" class="mx-2" style="color: var(--text-light); hover:color: var(--text-color);">Privacy</a>
                <a href="#" class="mx-2" style="color: var(--text-light); hover:color: var(--text-color);">Termini di servizio</a>
                <a href="#" class="mx-2" style="color: var(--text-light); hover:color: var(--text-color);">Contatti</a>
            </div>
        </div>
    </footer>

    <script>
        // Tab navigation
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');

                // Deactivate all tabs
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Activate current tab
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Charts initialization
        window.addEventListener('DOMContentLoaded', () => {
            // PREDIMED Chart
            const predimedCtx = document.getElementById('predimed-chart').getContext('2d');
            const predimedChart = new Chart(predimedCtx, {
                type: 'radar',
                data: {
                    labels: ['Olio oliva', 'Verdura', 'Frutta', 'Cereali', 'Legumi', 'Pesce', 'Vino'],
                    datasets: [{
                        label: 'Punteggio attuale',
                        data: [1, 1, 1, 0, 1, 0, 0],
                        backgroundColor: 'rgba(66, 133, 244, 0.2)',
                        borderColor: '#4285F4',
                        borderWidth: 2,
                        pointBackgroundColor: '#4285F4'
                    }, {
                        label: 'Obiettivo',
                        data: [1, 1, 1, 1, 1, 1, 1],
                        backgroundColor: 'rgba(52, 168, 83, 0.1)',
                        borderColor: '#34A853',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointBackgroundColor: '#34A853'
                    }]
                },
                options: {
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 1,
                            stepSize: 1
                        }
                    }
                }
            });

            // Macronutrienti Chart
            const macroCtx = document.getElementById('macro-chart').getContext('2d');
            const macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Proteine', 'Carboidrati', 'Grassi'],
                    datasets: [{
                        data: [25, 45, 30],
                        backgroundColor: ['#34A853', '#4285F4', '#FBBC05'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {

            // Store chart instances globally
            let predimedChart = null;
            let macroChart = null;

            // Initialize charts
            initializeCharts();

            function initializeCharts() {
                // PREDIMED Chart
                const predimedCtx = document.getElementById('predimed-chart').getContext('2d');
                predimedChart = new Chart(predimedCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Olio oliva', 'Verdura', 'Frutta', 'Cereali', 'Legumi', 'Pesce', 'Vino'],
                        datasets: [{
                            label: 'Punteggio attuale',
                            data: [1, 1, 1, 0, 1, 0, 0],
                            backgroundColor: 'rgba(66, 133, 244, 0.2)',
                            borderColor: '#4285F4',
                            borderWidth: 2,
                            pointBackgroundColor: '#4285F4'
                        }, {
                            label: 'Obiettivo',
                            data: [1, 1, 1, 1, 1, 1, 1],
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            borderColor: '#34A853',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointBackgroundColor: '#34A853'
                        }]
                    },
                    options: {
                        scale: {
                            ticks: {
                                beginAtZero: true,
                                max: 1,
                                stepSize: 1
                            }
                        }
                    }
                });

                // Macronutrienti Chart
                const macroCtx = document.getElementById('macro-chart').getContext('2d');
                macroChart = new Chart(macroCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Proteine', 'Carboidrati', 'Grassi'],
                        datasets: [{
                            data: [25, 45, 30],
                            backgroundColor: ['#34A853', '#4285F4', '#FBBC05'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Find the export button
            const exportButton = document.querySelector('button:has(i.fas.fa-file-pdf)') ||
                                 document.querySelector('button i.fas.fa-file-pdf')?.closest('button');

            // Add click event listener to the export button
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    // Show loading indicator
                    const originalButtonText = exportButton.innerHTML;
                    exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Esportazione...';
                    exportButton.disabled = true;

                    // Make sure all tabs are displayed before export (to ensure charts are rendered)
                    const currentActiveTab = document.querySelector('.tab-content.active');
                    const allTabs = document.querySelectorAll('.tab-content');

                    // Show all tabs temporarily
                    allTabs.forEach(tab => tab.classList.add('active'));

                    // Force chart update to ensure they're rendered
                    if (predimedChart) predimedChart.update();
                    if (macroChart) macroChart.update();

                    // Small delay to ensure all charts are fully rendered
                    setTimeout(() => {
                        // Get the dashboard content to export
                        const dashboardContent = document.querySelector('main');

                        // Set options for PDF generation
                        const options = {
                            margin: 10,
                            filename: 'Dashboard_HealthAI_' + new Date().toLocaleDateString('it-IT') + '.pdf',
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: {
                                scale: 1,
                                useCORS: true,
                                logging: false,
                                allowTaint: true,
                                foreignObjectRendering: false
                            },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };

                        // Generate and download PDF
                        html2pdf().from(dashboardContent).set(options).save()
                            .then(() => {
                                // Hide all tabs except the one that was originally active
                                allTabs.forEach(tab => tab.classList.remove('active'));
                                if (currentActiveTab) currentActiveTab.classList.add('active');

                                // Restore button text after PDF is generated
                                exportButton.innerHTML = originalButtonText;
                                exportButton.disabled = false;

                                // Show success notification
                                showNotification('PDF esportato con successo!', 'success');
                            })
                            .catch(error => {
                                console.error('Errore durante l\'esportazione del PDF:', error);

                                // Hide all tabs except the one that was originally active
                                allTabs.forEach(tab => tab.classList.remove('active'));
                                if (currentActiveTab) currentActiveTab.classList.add('active');

                                exportButton.innerHTML = originalButtonText;
                                exportButton.disabled = false;

                                // Show error notification
                                showNotification('Errore durante l\'esportazione del PDF', 'error');
                            });
                    }, 500); // Wait 500ms for charts to render
                });
            }

            // Function to show notifications
            function showNotification(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-500' : 'bg-red-500'
                } text-white`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;

                // Add to document
                document.body.appendChild(notification);

                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 3000);
            }

            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    // Deactivate all tabs
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    // Activate current tab
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Update the charts if they're in the active tab
                    if (tabId === 'tab-stile-vita' && predimedChart) {
                        predimedChart.update();
                    }
                    if (tabId === 'tab-nutritional' && macroChart) {
                        macroChart.update();
                    }
                });
            });
        });

// Gestione temi (da mantenere in tutte le pagine)
        document.addEventListener('DOMContentLoaded', function () {
            const themeToggle = document.getElementById('theme-toggle');

            function applyTheme(theme) {
                const html = document.documentElement;
                html.setAttribute('data-theme', theme);

                if (themeToggle) {
                    themeToggle.textContent = (theme === 'dark') ? '‚òÄÔ∏è' : 'üåô';
                }
            }

            // Listener per il toggle manuale
            if (themeToggle) {
                themeToggle.addEventListener('click', function () {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    applyTheme(newTheme);

                    // Comunica al parent il nuovo tema
                    window.parent.postMessage({ type: 'theme', theme: newTheme }, '*');
                });
            }

            // Listener per ricevere tema dal parent
            window.addEventListener('message', function (event) {
                if (event.data && event.data.type === 'theme') {
                    applyTheme(event.data.theme);
                }
            });
        });
    </script>
    <script>
// Configuration constants
const supabaseUrl = 'https://lwuhdgrkaoyvejmzfbtx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3dWhkZ3JrYW95dmVqbXpmYnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2NzU1MDcsImV4cCI6MjA2MTI1MTUwN30.1c5iH4PYW-HeigfXkPSgnVK3t02Gv3krSeo7dDSqqsk';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Variabili globali per i dati utente
let userData = {};
let dashboardData = {
    bmi: { value: 0, category: '', status: '' },
    score2: { value: 0, risk: '', category: '' },
    predimed: { value: 0, adherence: '' },
    metabolicSyndrome: { present: false, criteria: 0, factors: [] },
    diabetesRisk: { score: 0, factors: [] },
    recommendations: [],
    screenings: [],
    lifestyle: {},
    nutrition: {},
    activity: {}
};

// Store chart instances globally
let predimedChart = null;
let macroChart = null;

// Carica i dati dell'utente all'avvio
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Verifica autenticazione
        const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError || !sessionData.session) {
            window.location.href = 'login.html';
            return;
        }

        const emailUtente = sessionData.session.user.email;
        
        // Carica dati dal database
        await loadUserData(emailUtente);
        
        // Calcola tutti gli score
        calculateAllScores();
        
        // Aggiorna la dashboard
        updateDashboard();
        
        // Inizializza i grafici
        initializeCharts();
        
        // Setup delle tabs
        setupTabs();
        
        // Setup export PDF
        setupExportButton();
        
    } catch (error) {
        console.error('Errore inizializzazione dashboard:', error);
    }
});

// Funzione per caricare i dati utente
async function loadUserData(email) {
    try {
        const { data, error } = await supabaseClient
            .from('anagrafica_utenti')
            .select('*')
            .eq('email', email)
            .single();
            
        if (error) throw error;
        
        userData = data || {};
        console.log('Dati utente caricati:', userData);
        
    } catch (error) {
        console.error('Errore caricamento dati:', error);
    }
}

// Calcola tutti gli score clinici
function calculateAllScores() {
    // 1. Calcola BMI
    calculateBMI();
    
    // 2. Calcola SCORE2 (rischio cardiovascolare)
    calculateSCORE2();
    
    // 3. Calcola PREDIMED (dieta mediterranea)
    calculatePREDIMED();
    
    // 4. Verifica sindrome metabolica
    checkMetabolicSyndrome();
    
    // 5. Calcola rischio diabete (ADA)
    calculateDiabetesRisk();
    
    // 6. Genera raccomandazioni
    generateRecommendations();
    
    // 7. Determina screening necessari
    determineScreenings();
    
    // 8. Analizza stile di vita
    analyzeLifestyle();
    
    // 9. Calcola fabbisogno nutrizionale
    calculateNutritionalNeeds();
    
    // 10. Valuta attivit√† fisica
    evaluatePhysicalActivity();
}

// 1. Calcolo BMI
function calculateBMI() {
    const peso = parseFloat(userData.peso);
    const altezza = parseFloat(userData.altezza) / 100; // converti in metri
    
    if (peso && altezza) {
        const bmi = peso / (altezza * altezza);
        dashboardData.bmi.value = bmi.toFixed(1);
        
        // Determina categoria
        if (bmi < 18.5) {
            dashboardData.bmi.category = 'Sottopeso';
            dashboardData.bmi.status = 'warning';
        } else if (bmi < 25) {
            dashboardData.bmi.category = 'Normopeso';
            dashboardData.bmi.status = 'success';
        } else if (bmi < 30) {
            dashboardData.bmi.category = 'Sovrappeso';
            dashboardData.bmi.status = 'warning';
        } else {
            dashboardData.bmi.category = 'Obesit√†';
            dashboardData.bmi.status = 'danger';
        }
    }
}

// 2. Calcolo SCORE2
function calculateSCORE2() {
    const eta = parseInt(userData.eta);
    const sesso = userData.sesso?.toLowerCase();
    const sistolica = parseFloat(userData.pressione_sistolica);
    const colTotale = parseFloat(userData.colesterolo_totale);
    const hdl = parseFloat(userData.colesterolo_hdl_valore);
    const fumatore = userData.fumatore?.toLowerCase() === 's√¨';
    
    if (eta && sistolica && colTotale && hdl) {
        // Formula semplificata SCORE2 (in realt√† √® pi√π complessa)
        let score = 0;
        
        // Fattore et√†
        if (eta >= 40 && eta < 50) score += 0;
        else if (eta >= 50 && eta < 60) score += 3;
        else if (eta >= 60 && eta < 70) score += 6;
        else if (eta >= 70) score += 9;
        
        // Fattore pressione
        if (sistolica >= 140) score += 2;
        if (sistolica >= 160) score += 3;
        if (sistolica >= 180) score += 4;
        
        // Fattore colesterolo
        const nonHDL = colTotale - hdl;
        if (nonHDL >= 190) score += 1;
        if (nonHDL >= 220) score += 2;
        if (nonHDL >= 280) score += 3;
        
        // Fattore fumo
        if (fumatore) score += 4;
        
        // Converti in percentuale di rischio
        const riskPercent = Math.min(score * 0.5, 20); // Max 20%
        
        dashboardData.score2.value = riskPercent.toFixed(1);
        
        // Determina categoria di rischio
        if (riskPercent < 1) {
            dashboardData.score2.risk = 'Basso';
            dashboardData.score2.category = 'success';
        } else if (riskPercent < 5) {
            dashboardData.score2.risk = 'Moderato';
            dashboardData.score2.category = 'warning';
        } else if (riskPercent < 10) {
            dashboardData.score2.risk = 'Alto';
            dashboardData.score2.category = 'danger';
        } else {
            dashboardData.score2.risk = 'Molto alto';
            dashboardData.score2.category = 'danger';
        }
    }
}

// 3. Calcolo PREDIMED
function calculatePREDIMED() {
    let score = 0;
    
    // Somma tutti i punteggi PREDIMED (14 domande)
    for (let i = 1; i <= 14; i++) {
        const value = userData[`predimed_${i}`];
        if (value?.toLowerCase() === 's√¨' || value === '1' || value === true) {
            score++;
        }
    }
    
    dashboardData.predimed.value = score;
    
    // Determina livello di aderenza
    if (score >= 10) {
        dashboardData.predimed.adherence = 'Alta aderenza';
        dashboardData.predimed.status = 'success';
    } else if (score >= 6) {
        dashboardData.predimed.adherence = 'Media aderenza';
        dashboardData.predimed.status = 'warning';
    } else {
        dashboardData.predimed.adherence = 'Bassa aderenza';
        dashboardData.predimed.status = 'danger';
    }
}

// 4. Verifica sindrome metabolica
function checkMetabolicSyndrome() {
    let criteria = 0;
    let factors = [];
    
    // Criterio 1: Circonferenza vita
    if (userData.vita?.toLowerCase() === 's√¨') {
        criteria++;
        factors.push('Girovita elevato');
    }
    
    // Criterio 2: Glicemia
    const glicemia = parseFloat(userData.glicemia_valore);
    if (glicemia >= 100 || userData.diabete?.toLowerCase() === 's√¨') {
        criteria++;
        factors.push('Glicemia alta');
    }
    
    // Criterio 3: HDL basso
    if (userData.colesterolo_hdl?.toLowerCase() === 's√¨') {
        criteria++;
        factors.push('HDL basso');
    }
    
    // Criterio 4: Pressione alta
    const sistolica = parseFloat(userData.pressione_sistolica);
    const diastolica = parseFloat(userData.pressione_diastolica);
    if (sistolica >= 130 || diastolica >= 85) {
        criteria++;
        factors.push('Pressione elevata');
    }
    
    // Criterio 5: Trigliceridi (non abbiamo questo dato, quindi lo simuliamo)
    // In un'app reale, dovresti chiedere questo dato
    
    dashboardData.metabolicSyndrome = {
        present: criteria >= 3,
        criteria: criteria,
        factors: factors
    };
}

// 5. Calcolo rischio diabete (ADA Risk Score)
function calculateDiabetesRisk() {
    let score = 0;
    let factors = [];
    
    const eta = parseInt(userData.eta);
    const sesso = userData.sesso?.toLowerCase();
    const bmi = parseFloat(dashboardData.bmi.value);
    
    // Et√†
    if (eta >= 40 && eta < 50) {
        score += 1;
        factors.push('Et√† 40-49');
    } else if (eta >= 50 && eta < 60) {
        score += 2;
        factors.push('Et√† 50-59');
    } else if (eta >= 60) {
        score += 3;
        factors.push('Et√† ‚â•60');
    }
    
    // BMI
    if (bmi >= 25 && bmi < 30) {
        score += 1;
        factors.push('Sovrappeso');
    } else if (bmi >= 30 && bmi < 40) {
        score += 2;
        factors.push('Obesit√†');
    } else if (bmi >= 40) {
        score += 3;
        factors.push('Obesit√† grave');
    }
    
    // Familiarit√†
    if (userData.familiari_diabete?.toLowerCase() === 's√¨') {
        score += 1;
        factors.push('Familiarit√† diabete');
    }
    
    // Ipertensione
    if (userData.pressione_alta?.toLowerCase() === 's√¨' || 
        parseFloat(userData.pressione_sistolica) >= 140) {
        score += 1;
        factors.push('Ipertensione');
    }
    
    // Attivit√† fisica
    if (userData.attivita_fisica?.toLowerCase() === 'no' ||
        userData.attivo30?.toLowerCase() === 'no') {
        score += 1;
        factors.push('Sedentariet√†');
    }
    
    dashboardData.diabetesRisk = {
        score: score,
        maxScore: 8,
        factors: factors,
        risk: score >= 5 ? 'Alto' : score >= 3 ? 'Moderato' : 'Basso'
    };
}

// 6. Genera raccomandazioni personalizzate
function generateRecommendations() {
    dashboardData.recommendations = [];
    
    // Raccomandazioni basate su BMI
    if (dashboardData.bmi.status === 'warning' || dashboardData.bmi.status === 'danger') {
        dashboardData.recommendations.push({
            title: 'Controllo del peso',
            description: 'Raggiungere un BMI tra 18.5 e 25 attraverso dieta equilibrata',
            priority: 'high'
        });
    }
    
    // Raccomandazioni basate su rischio cardiovascolare
    if (parseFloat(dashboardData.score2.value) >= 5) {
        dashboardData.recommendations.push({
            title: 'Ridurre rischio cardiovascolare',
            description: 'Controllo pressione, colesterolo e cessazione fumo',
            priority: 'high'
        });
    }
    
    // Raccomandazioni basate su PREDIMED
    if (dashboardData.predimed.value < 10) {
        dashboardData.recommendations.push({
            title: 'Migliorare alimentazione',
            description: 'Aumentare aderenza alla dieta mediterranea',
            priority: 'medium'
        });
    }
    
    // Raccomandazioni attivit√† fisica
    if (userData.attivita_fisica?.toLowerCase() === 'no') {
        dashboardData.recommendations.push({
            title: 'Aumentare attivit√† fisica',
            description: 'Raggiungere almeno 150 minuti di attivit√† moderata a settimana',
            priority: 'high'
        });
    }
    
    // Raccomandazioni sonno/stress
    if (userData.insonnia?.toLowerCase() === 's√¨' || parseInt(userData.stress) > 7) {
        dashboardData.recommendations.push({
            title: 'Migliorare qualit√† del sonno',
            description: 'Creare routine serale e gestire lo stress',
            priority: 'medium'
        });
    }
}

// 7. Determina screening necessari
function determineScreenings() {
    dashboardData.screenings = [];
    const eta = parseInt(userData.eta);
    const sesso = userData.sesso?.toLowerCase();
    
    // Screening universali
    dashboardData.screenings.push({
        name: 'Controllo pressione arteriosa',
        frequency: 'Annuale',
        status: 'pending',
        dueIn: '2 mesi'
    });
    
    dashboardData.screenings.push({
        name: 'Esami del sangue completi',
        frequency: 'Annuale',
        status: 'overdue',
        dueIn: 'Scaduto'
    });
    
    // Screening et√†-specifici
    if (eta >= 50) {
        dashboardData.screenings.push({
            name: 'Screening colon-retto',
            frequency: 'Ogni 2 anni',
            status: 'completed',
            dueIn: '2024'
        });
    }
    
    if (eta >= 45 || dashboardData.diabetesRisk.risk !== 'Basso') {
        dashboardData.screenings.push({
            name: 'Screening diabete',
            frequency: 'Ogni 3 anni',
            status: 'pending',
            dueIn: '6 mesi'
        });
    }
    
    // Screening sesso-specifici
    if ((sesso === 'femmina' || sesso === 'donna') && eta >= 40) {
        dashboardData.screenings.push({
            name: 'Mammografia',
            frequency: 'Ogni 2 anni',
            status: 'pending',
            dueIn: '3 mesi'
        });
    }
}

// 8. Analizza stile di vita
function analyzeLifestyle() {
    const stress = parseInt(userData.stress) || 5;
    const hasInsomnia = userData.insonnia?.toLowerCase() === 's√¨';
    const hasDepression = userData.depressione?.toLowerCase() === 's√¨';
    
    dashboardData.lifestyle = {
        stress: {
            level: stress,
            category: stress <= 3 ? 'Basso' : stress <= 7 ? 'Medio' : 'Alto',
            percentage: (stress / 10) * 100
        },
        sleep: {
            quality: hasInsomnia ? 'Insufficiente' : 'Buona',
            percentage: hasInsomnia ? 30 : 80,
            issues: userData.tipo_insonnia || ''
        },
        mood: {
            status: hasDepression ? 'Da monitorare' : 'Buono',
            percentage: hasDepression ? 40 : 75
        }
    };
}

// 9. Calcola fabbisogno nutrizionale
function calculateNutritionalNeeds() {
    const peso = parseFloat(userData.peso);
    const altezza = parseFloat(userData.altezza);
    const eta = parseInt(userData.eta);
    const sesso = userData.sesso?.toLowerCase();
    const attivita = userData.tipo_lavoro || 'sedentario';
    
    // Calcolo BMR (Mifflin-St Jeor)
    let bmr;
    if (sesso === 'maschio' || sesso === 'uomo') {
        bmr = (10 * peso) + (6.25 * altezza) - (5 * eta) + 5;
    } else {
        bmr = (10 * peso) + (6.25 * altezza) - (5 * eta) - 161;
    }
    
    // Fattori attivit√†
    const activityFactors = {
        'sedentario': 1.2,
        'leggermente attivo': 1.375,
        'moderatamente attivo': 1.55,
        'molto attivo': 1.725,
        'estremamente attivo': 1.9
    };
    
    const tdee = bmr * (activityFactors[attivita] || 1.2);
    
    // Obiettivo calorico (assumiamo dimagrimento moderato se BMI > 25)
    const targetCalories = dashboardData.bmi.value > 25 ? tdee - 300 : tdee;
    
    dashboardData.nutrition = {
        bmr: Math.round(bmr),
        tdee: Math.round(tdee),
        target: Math.round(targetCalories),
        objective: dashboardData.bmi.value > 25 ? 'Dimagrimento moderato' : 'Mantenimento',
        activityLevel: attivita,
        macros: {
            protein: { percentage: 25, grams: Math.round(targetCalories * 0.25 / 4) },
            carbs: { percentage: 45, grams: Math.round(targetCalories * 0.45 / 4) },
            fats: { percentage: 30, grams: Math.round(targetCalories * 0.30 / 9) }
        }
    };
}

// 10. Valuta attivit√† fisica
function evaluatePhysicalActivity() {
    const isActive = userData.attivita_fisica?.toLowerCase() === 's√¨';
    const frequency = userData.frequenza_attivita_fisica || '0 volte/settimana';
    const duration = parseInt(userData.durata_attivita) || 0;
    const type = userData.tipo_attivita || '';
    
    // Estrai frequenza numerica
    const weeklyFrequency = parseInt(frequency.match(/\d+/)?.[0]) || 0;
    const weeklyMinutes = weeklyFrequency * duration;
    
    dashboardData.activity = {
        current: {
            frequency: frequency,
            type: type,
            duration: duration + ' minuti',
            intensity: 'Moderata',
            weeklyMinutes: weeklyMinutes
        },
        target: {
            aerobic: 150,
            strength: 2
        },
        compliance: {
            percentage: Math.min((weeklyMinutes / 150) * 100, 100),
            status: weeklyMinutes >= 150 ? 'Adeguata' : 'Insufficiente'
        },
        suggestions: []
    };
    
    // Genera suggerimenti
    if (weeklyMinutes < 150) {
        dashboardData.activity.suggestions.push({
            type: 'Obiettivo principale',
            text: 'Aumentare l\'attivit√† aerobica a 150 min/settimana'
        });
    }
    
    if (!type.includes('forza') && !type.includes('rafforzamento')) {
        dashboardData.activity.suggestions.push({
            type: 'Tipo di allenamento',
            text: 'Aggiungere esercizi di forza 2 volte/settimana'
        });
    }
}

// Aggiorna tutti gli elementi della dashboard
function updateDashboard() {
    // Aggiorna sezione riepilogo salute
    updateHealthSummary();
    
    // Aggiorna profilo metabolico
    updateMetabolicProfile();
    
    // Aggiorna contenuti delle tab
    updateRiskTab();
    updateScreeningTab();
    updateLifestyleTab();
    updateNutritionTab();
    updateActivityTab();
    
    // Aggiorna raccomandazioni
    updateRecommendations();
    
    // Aggiorna prossimi passi
    updateNextSteps();
}

// Funzioni di aggiornamento UI
function updateHealthSummary() {
    // BMI
    document.querySelector('.score-indicator.score-medium').textContent = dashboardData.bmi.value;
    document.querySelector('.score-indicator.score-medium').className = `score-indicator score-${dashboardData.bmi.status === 'success' ? 'medium' : dashboardData.bmi.status === 'warning' ? 'low' : 'high'}`;
    
    const bmiCard = document.querySelector('.bg-blue-50:first-child');
    if (bmiCard) {
        bmiCard.querySelector('.badge').textContent = dashboardData.bmi.category;
        bmiCard.querySelector('.badge').className = `badge badge-${dashboardData.bmi.status}`;
        bmiCard.querySelector('.font-medium').textContent = dashboardData.bmi.category;
    }
    
    // SCORE2
    const score2Card = document.querySelectorAll('.bg-blue-50')[1];
    if (score2Card) {
        score2Card.querySelector('.score-indicator').textContent = dashboardData.score2.value + '%';
        score2Card.querySelector('.badge').textContent = dashboardData.score2.risk;
        score2Card.querySelector('.badge').className = `badge badge-${dashboardData.score2.category === 'success' ? 'success' : dashboardData.score2.category === 'warning' ? 'warning' : 'danger'}`;
        score2Card.querySelector('.font-medium').textContent = dashboardData.score2.risk;
    }
    
    // PREDIMED
    const predimedCard = document.querySelectorAll('.bg-blue-50')[2];
    if (predimedCard) {
        predimedCard.querySelector('.score-indicator').textContent = dashboardData.predimed.value;
        predimedCard.querySelector('.badge').textContent = dashboardData.predimed.status === 'success' ? 'Buona' : dashboardData.predimed.status === 'warning' ? 'Migliorabile' : 'Scarsa';
        predimedCard.querySelector('.badge').className = `badge badge-${dashboardData.predimed.status}`;
        predimedCard.querySelector('.font-medium').textContent = dashboardData.predimed.adherence;
    }
}

function updateMetabolicProfile() {
    const metabolicSection = document.querySelector('.card .space-y-3');
    if (!metabolicSection) return;
    
    // Aggiorna stato sindrome metabolica
    const badge = metabolicSection.querySelector('.badge');
    badge.textContent = dashboardData.metabolicSyndrome.present ? 'Presente' : 'Assente';
    badge.className = `badge badge-${dashboardData.metabolicSyndrome.present ? 'danger' : 'success'}`;
    
    // Aggiorna progress bar
    const progressBar = metabolicSection.querySelector('.bg-red-500');
    const percentage = (dashboardData.metabolicSyndrome.criteria / 5) * 100;
    progressBar.style.width = percentage + '%';
    progressBar.className = `h-2.5 rounded-full ${dashboardData.metabolicSyndrome.present ? 'bg-red-500' : 'bg-yellow-500'}`;
    
    // Aggiorna testo criteri
    metabolicSection.querySelector('.text-xs').textContent = 
        `${dashboardData.metabolicSyndrome.criteria} criteri soddisfatti su 5`;
    
    // Aggiorna badges dei fattori
    const factorsContainer = metabolicSection.querySelector('.flex.flex-wrap.gap-2');
    factorsContainer.innerHTML = dashboardData.metabolicSyndrome.factors
        .map(factor => `<div class="badge badge-danger">${factor}</div>`)
        .join('');
}

function updateRiskTab() {
    // Aggiorna grafico rischio cardiovascolare
    const cvRisk = document.querySelector('#tab-rischi .progress-ring__circle');
    if (cvRisk) {
        const percentage = parseFloat(dashboardData.score2.value);
        const circumference = 314.16; // 2 * œÄ * 50
        const offset = circumference - (percentage / 100 * circumference);
        cvRisk.style.strokeDashoffset = offset;
    }
    
    // Aggiorna testo rischio CV
    const cvText = document.querySelector('#tab-rischi text');
    if (cvText) cvText.textContent = dashboardData.score2.value + '%';
    
    // Aggiorna dettagli
    const cvDetails = document.querySelector('#tab-rischi .space-y-2');
    if (cvDetails) {
        cvDetails.innerHTML = `
            <div class="flex justify-between text-sm">
                <span>Et√†</span>
                <span class="font-medium">${userData.eta || 'N/D'} anni</span>
            </div>
            <div class="flex justify-between text-sm">
                <span>Pressione</span>
                <span class="font-medium">${userData.pressione_sistolica || 'N/D'}/${userData.pressione_diastolica || 'N/D'} mmHg</span>
            </div>
            <div class="flex justify-between text-sm">
                <span>Colesterolo HDL</span>
                <span class="font-medium">${userData.colesterolo_hdl_valore || 'N/D'} mg/dL</span>
            </div>
            <div class="flex justify-between text-sm">
                <span>Fumo</span>
                <span class="font-medium">${userData.fumatore || 'No'}</span>
            </div>
        `;
    }
    
    // Aggiorna rischio diabete
    const diabetesCircle = document.querySelectorAll('#tab-rischi .progress-ring__circle')[1];
    if (diabetesCircle) {
        const score = dashboardData.diabetesRisk.score;
        const maxScore = dashboardData.diabetesRisk.maxScore;
        const percentage = (score / maxScore) * 100;
        const offset = 314.16 - (percentage / 100 * 314.16);
        diabetesCircle.style.strokeDashoffset = offset;
    }
    
    // Aggiorna testo rischio diabete
    const diabetesText = document.querySelectorAll('#tab-rischi text')[1];
    if (diabetesText) diabetesText.textContent = `${dashboardData.diabetesRisk.score}/${dashboardData.diabetesRisk.maxScore}`;
}

function updateScreeningTab() {
    const container = document.querySelector('#tab-screening .space-y-3');
    if (!container) return;
    
    container.innerHTML = dashboardData.screenings.map(screening => {
        const borderColor = screening.status === 'completed' ? 'border-green-500' : 
                          screening.status === 'pending' ? 'border-yellow-500' : 'border-red-500';
        const badgeClass = screening.status === 'completed' ? 'badge-success' : 
                         screening.status === 'pending' ? 'badge-warning' : 'badge-danger';
        const badgeText = screening.status === 'completed' ? 'Completo' : 
                        screening.status === 'pending' ? 'In scadenza' : 'Scaduto';
        
        return `
            <div class="flex items-center p-2 rounded border-l-4 ${borderColor}">
                <div class="flex-1">
                    <h4 class="font-medium">${screening.name}</h4>
                    <p class="text-sm text-gray-600">Raccomandato ${screening.frequency}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="badge ${badgeClass}">${badgeText}</span>
                    <span class="text-xs text-gray-500">${screening.dueIn}</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateLifestyleTab() {
    // Aggiorna grafico PREDIMED
    if (predimedChart) {
        const predimedData = [
            userData.predimed_1 === 's√¨' ? 1 : 0,
            userData.predimed_2 === 's√¨' ? 1 : 0,
            userData.predimed_3 === 's√¨' ? 1 : 0,
            userData.predimed_4 === 's√¨' ? 1 : 0,
            userData.predimed_5 === 's√¨' ? 1 : 0,
            userData.predimed_6 === 's√¨' ? 1 : 0,
            userData.predimed_7 === 's√¨' ? 1 : 0
        ];
        
        predimedChart.data.datasets[0].data = predimedData;
        predimedChart.update();
    }
    
    // Aggiorna punteggio PREDIMED
    const predimedScore = document.querySelector('#tab-stile-vita .text-center p');
    if (predimedScore) {
        predimedScore.innerHTML = `Punteggio attuale: <span class="font-medium">${dashboardData.predimed.value}/14</span><br>
                                  Aderenza alla dieta mediterranea: <span class="font-medium">${dashboardData.predimed.adherence}</span>`;
    }
    
    // Aggiorna benessere psicologico
    const stressBar = document.querySelector('#tab-stile-vita .bg-yellow-500');
    if (stressBar) {
        stressBar.style.width = dashboardData.lifestyle.stress.percentage + '%';
        stressBar.className = `h-2 rounded-full ${dashboardData.lifestyle.stress.percentage > 70 ? 'bg-red-500' : dashboardData.lifestyle.stress.percentage > 40 ? 'bg-yellow-500' : 'bg-green-500'}`;
    }
    
    const sleepBar = document.querySelector('#tab-stile-vita .bg-red-500');
    if (sleepBar) {
        sleepBar.style.width = dashboardData.lifestyle.sleep.percentage + '%';
        sleepBar.className = `h-2 rounded-full ${dashboardData.lifestyle.sleep.percentage < 40 ? 'bg-red-500' : dashboardData.lifestyle.sleep.percentage < 70 ? 'bg-yellow-500' : 'bg-green-500'}`;
    }
    
    const moodBar = document.querySelector('#tab-stile-vita .bg-green-500');
    if (moodBar) {
        moodBar.style.width = dashboardData.lifestyle.mood.percentage + '%';
    }
}

function updateNutritionTab() {
    // Aggiorna fabbisogno calorico
    const nutritionDetails = document.querySelector('#tab-nutritional .space-y-3');
    if (nutritionDetails) {
        nutritionDetails.innerHTML = `
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">BMR</span>
                <span class="font-medium">${dashboardData.nutrition.bmr} kcal</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">TDEE</span>
                <span class="font-medium">${dashboardData.nutrition.tdee} kcal</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Obiettivo</span>
                <span class="font-medium">${dashboardData.nutrition.objective}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Calorie suggerite</span>
                <span class="font-medium text-blue-600">${dashboardData.nutrition.target} kcal</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Attivit√† fisica</span>
                <span class="font-medium">${dashboardData.nutrition.activityLevel}</span>
            </div>
        `;
    }
    
    // Aggiorna grafico macronutrienti
    if (macroChart) {
        macroChart.data.datasets[0].data = [
            dashboardData.nutrition.macros.protein.percentage,
            dashboardData.nutrition.macros.carbs.percentage,
            dashboardData.nutrition.macros.fats.percentage
        ];
        macroChart.update();
    }
    
    // Aggiorna dettagli macronutrienti
    const macroDetails = document.querySelector('#tab-nutritional .grid.grid-cols-3');
    if (macroDetails) {
        macroDetails.innerHTML = `
            <div class="p-2 rounded-lg">
                <div class="text-sm font-medium">Proteine</div>
                <div class="text-lg font-bold text-green-600">${dashboardData.nutrition.macros.protein.percentage}%</div>
                <div class="text-xs text-gray-500">${dashboardData.nutrition.macros.protein.grams}g</div>
            </div>
            <div class="p-2 rounded-lg">
                <div class="text-sm font-medium">Carboidrati</div>
                <div class="text-lg font-bold text-blue-600">${dashboardData.nutrition.macros.carbs.percentage}%</div>
                <div class="text-xs text-gray-500">${dashboardData.nutrition.macros.carbs.grams}g</div>
            </div>
            <div class="p-2 rounded-lg">
                <div class="text-sm font-medium">Grassi</div>
                <div class="text-lg font-bold text-yellow-600">${dashboardData.nutrition.macros.fats.percentage}%</div>
                <div class="text-xs text-gray-500">${dashboardData.nutrition.macros.fats.grams}g</div>
            </div>
        `;
    }
}

function updateActivityTab() {
    // Aggiorna attivit√† attuale
    const activityDetails = document.querySelector('#tab-attivita .space-y-3');
    if (activityDetails) {
        activityDetails.innerHTML = `
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Frequenza</span>
                <span class="font-medium">${dashboardData.activity.current.frequency}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Tipo</span>
                <span class="font-medium">${dashboardData.activity.current.type || 'Non specificato'}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Durata</span>
                <span class="font-medium">${dashboardData.activity.current.duration}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Intensit√†</span>
                <span class="font-medium text-yellow-600">${dashboardData.activity.current.intensity}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Minuti/settimana</span>
                <span class="font-medium ${dashboardData.activity.compliance.status === 'Adeguata' ? 'text-green-600' : 'text-red-600'}">${dashboardData.activity.current.weeklyMinutes} (${dashboardData.activity.compliance.status})</span>
            </div>
        `;
    }
    
    // Aggiorna suggerimenti
    const suggestionsContainer = document.querySelectorAll('#tab-attivita .space-y-3')[1];
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = dashboardData.activity.suggestions.map(suggestion => `
            <div class="p-3 rounded-lg border-l-4 border-blue-500">
                <h4 class="font-medium">${suggestion.type}</h4>
                <p class="text-sm text-gray-600">${suggestion.text}</p>
            </div>
        `).join('') || `
            <div class="p-3 rounded-lg border-l-4 border-green-500">
                <h4 class="font-medium">Ottimo lavoro!</h4>
                <p class="text-sm text-gray-600">Stai gi√† raggiungendo gli obiettivi di attivit√† fisica raccomandati</p>
            </div>
        `;
    }
}

function updateRecommendations() {
    const container = document.querySelector('.recommendation-card').parentElement;
    if (!container) return;
    
    container.innerHTML = dashboardData.recommendations
        .slice(0, 3) // Mostra solo le prime 3 raccomandazioni
        .map(rec => `
            <div class="recommendation-card p-3 bg-gray-50">
                <h3 class="font-medium">${rec.title}</h3>
                <p class="text-sm text-gray-600">${rec.description}</p>
            </div>
        `).join('');
}

function updateNextSteps() {
    const container = document.querySelector('.card:last-child .space-y-3');
    if (!container) return;
    
    const nextSteps = [];
    
    // Aggiungi visite basate sui rischi
    if (dashboardData.score2.risk === 'Alto' || dashboardData.score2.risk === 'Molto alto') {
        nextSteps.push({
            title: 'Visita cardiologica',
            description: 'Per rivalutazione parametri cardiovascolari',
            timeframe: 'Entro 30 giorni'
        });
    }
    
    if (dashboardData.diabetesRisk.risk === 'Alto') {
        nextSteps.push({
            title: 'Visita diabetologica',
            description: 'Per valutazione rischio diabete',
            timeframe: 'Entro 30 giorni'
        });
    }
    
    // Aggiungi esami se necessari
    const overdueScreenings = dashboardData.screenings.filter(s => s.status === 'overdue');
    if (overdueScreenings.length > 0) {
        nextSteps.push({
            title: overdueScreenings[0].name,
            description: `Screening ${overdueScreenings[0].status}`,
            timeframe: 'Immediato'
        });
    }
    
    // Se non ci sono passi urgenti, aggiungi consigli generali
    if (nextSteps.length === 0) {
        nextSteps.push({
            title: 'Mantenere stile di vita sano',
            description: 'Continua con le buone abitudini',
            timeframe: 'Ongoing'
        });
    }
    
    container.innerHTML = nextSteps.map((step, index) => `
        <div class="flex items-center p-2 bg-gray-50 rounded">
            <div class="bg-blue-100 text-blue-800 h-8 w-8 rounded-full flex items-center justify-center mr-3">${index + 1}</div>
            <div>
                <h4 class="font-medium">${step.title}</h4>
                <p class="text-xs text-gray-500">${step.timeframe}</p>
            </div>
        </div>
    `).join('');
}

// Inizializza i grafici
function initializeCharts() {
    // PREDIMED Chart
    const predimedCtx = document.getElementById('predimed-chart').getContext('2d');
    predimedChart = new Chart(predimedCtx, {
        type: 'radar',
        data: {
            labels: ['Olio oliva', 'Verdura', 'Frutta', 'Cereali', 'Legumi', 'Pesce', 'Vino'],
            datasets: [{
                label: 'Punteggio attuale',
                data: [0, 0, 0, 0, 0, 0, 0], // Sar√† aggiornato dopo
                backgroundColor: 'rgba(66, 133, 244, 0.2)',
                borderColor: '#4285F4',
                borderWidth: 2,
                pointBackgroundColor: '#4285F4'
            }, {
                label: 'Obiettivo',
                data: [1, 1, 1, 1, 1, 1, 1],
                backgroundColor: 'rgba(52, 168, 83, 0.1)',
                borderColor: '#34A853',
                borderWidth: 1,
                borderDash: [5, 5],
                pointBackgroundColor: '#34A853'
            }]
        },
        options: {
            scale: {
                ticks: {
                    beginAtZero: true,
                    max: 1,
                    stepSize: 1
                }
            }
        }
    });

    // Macronutrienti Chart
    const macroCtx = document.getElementById('macro-chart').getContext('2d');
    macroChart = new Chart(macroCtx, {
        type: 'doughnut',
        data: {
            labels: ['Proteine', 'Carboidrati', 'Grassi'],
            datasets: [{
                data: [25, 45, 30], // Sar√† aggiornato dopo
                backgroundColor: ['#34A853', '#4285F4', '#FBBC05'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Setup delle tabs
function setupTabs() {
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');

            // Deactivate all tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Activate current tab
            button.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Update charts if needed
            if (tabId === 'tab-stile-vita' && predimedChart) {
                predimedChart.update();
            }
            if (tabId === 'tab-nutritional' && macroChart) {
                macroChart.update();
            }
        });
    });
}

// Setup export button
function setupExportButton() {
    const exportButton = document.querySelector('button:has(i.fas.fa-file-pdf)');
    if (exportButton) {
        exportButton.addEventListener('click', exportDashboardPDF);
    }
}

// Funzione per esportare PDF
async function exportDashboardPDF() {
    const exportButton = document.querySelector('button:has(i.fas.fa-file-pdf)');
    const originalButtonText = exportButton.innerHTML;
    
    exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Esportazione...';
    exportButton.disabled = true;

    // Mostra temporaneamente tutte le tabs per l'export
    const currentActiveTab = document.querySelector('.tab-content.active');
    const allTabs = document.querySelectorAll('.tab-content');
    allTabs.forEach(tab => tab.classList.add('active'));

    // Aggiorna i grafici
    if (predimedChart) predimedChart.update();
    if (macroChart) macroChart.update();

    setTimeout(() => {
        const dashboardContent = document.querySelector('main');
        
        const options = {
            margin: 10,
            filename: `Dashboard_HealthAI_${userData.email}_${new Date().toLocaleDateString('it-IT')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 1,
                useCORS: true,
                logging: false,
                allowTaint: true,
                foreignObjectRendering: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(dashboardContent).set(options).save()
            .then(() => {
                // Ripristina solo la tab attiva originale
                allTabs.forEach(tab => tab.classList.remove('active'));
                if (currentActiveTab) currentActiveTab.classList.add('active');
                
                exportButton.innerHTML = originalButtonText;
                exportButton.disabled = false;
                
                showNotification('PDF esportato con successo!', 'success');
            })
            .catch(error => {
                console.error('Errore export PDF:', error);
                
                allTabs.forEach(tab => tab.classList.remove('active'));
                if (currentActiveTab) currentActiveTab.classList.add('active');
                
                exportButton.innerHTML = originalButtonText;
                exportButton.disabled = false;
                
                showNotification('Errore durante l\'esportazione', 'error');
            });
    }, 500);
}

// Funzione per mostrare notifiche
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// Auto-refresh ogni 5 minuti
setInterval(async () => {
    const { data: sessionData } = await supabaseClient.auth.getSession();
    if (sessionData.session) {
        await loadUserData(sessionData.session.user.email);
        calculateAllScores();
        updateDashboard();
    }
}, 300000); // 5 minuti

// Gestione logout
document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'login.html';
});
</script>
</body>
</html>
